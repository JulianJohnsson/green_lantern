<% content_for :title, "DÃ©tail d'une dÃ©pense" %>
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <div class="card transaction-title" style="background: <%= Category.find(@transaction.parent_category_id).color %>;">
        <div class="row align-items-center text-white">
          <div class="col-1">
            <%= link_to request.referer.present? ? request.referer : default_path, class: "btn btn-white btn-link" do %>
              <i class="material-icons">arrow_back</i>
            <% end %>
          </div>
          <div class="col-5">
            <h3><%= @transaction.description %></h3>
          </div>
          <div class="col-2" id="accuracy-level" data-toggle="tooltip" data-placement="bottom" data-container="body" data-original-title="<%= @accuracy_tooltip %>">
            <span class="emoji accuracy <%="active" if @transaction.accuracy > 0 %>">
              ðŸŽ¯
            </span>
            <span class="emoji accuracy <%="active" if @transaction.accuracy > 1 %>">
              ðŸŽ¯
            </span>
            <span class="emoji accuracy <%="active" if @transaction.accuracy > 2 %>">
              ðŸŽ¯
            </span>
          </div>
          <div class="col-4 text-center">
            <span id= "carbone" class="number number-md">
              <%= number_with_precision(@transaction.carbone, precision: 1) %>
            </span>
            <br>kgCO2
          </div>
        </div>
      </div>
      <div class="card">
        <div class="spinner">
          <div class="sk-chase">
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
          </div>
        </div>
        <div class="card-body">
          <h4 class="text-center">DÃ©tail</h4>

          <div class="row align-items-center">
            <div class="col-1 text-right">
              <h4><%= @transaction.category.emoji %></h4>
            </div>
            <div class="col-5">
              <%= render 'form', transaction: @transaction %>
            </div>
            <div class="col-2">
              <%= @transaction.date %>
            </div>
            <div class="col-4 text-center">
              <%= -1 * @transaction.amount %> â‚¬
            </div>
          </div>
          <% if @modifiers || @parent_modifiers %>
            <div class="row">
              <div class="col-md-12 modifiers-form">
                <hr>
                <p class="description">
                  Tu peux prÃ©ciser les options qui s'appliquent Ã  cette dÃ©pense en cliquant sur les boutons correspondant pour affiner son calcul carbone.
                </p>
                <% @modifiers.each do |modifier| %>
                  <% if @transaction.transaction_modifiers.find_by_modifier_id(modifier.id).present? %>
                    <% transaction_modifier = @transaction.transaction_modifiers.find_by_modifier_id(modifier.id) %>
                  <% else %>
                    <% transaction_modifier = TransactionModifier.new  %>
                  <% end %>
                  <div id="modifier-<%= modifier.id %>">
                    <%= form_with(model: transaction_modifier, remote: true) do |f| %>
                      <div class="field">
                        <%= f.hidden_field :transaction_id, :value => params[:id] %>
                        <%= f.hidden_field :modifier_id, :value => modifier.id %>
                        <%= f.label "#{modifier.name}" %>
                        <div class="form-group btn-group btn-group-toggle flex-wrap" data-toggle="buttons">
                          <%= f.collection_radio_buttons(:modifier_option_id, modifier.modifier_options, :id, :name, :selected => transaction_modifier.modifier_option_id) do |b| %>
                            <%= b.label(class: "btn btn-sm btn-outline-info") { b.radio_button(class: "radio-auto-submit") + b.text.humanize } %>
                          <% end %>
                        </div>
                        <% if @transaction.transaction_modifiers.find_by_modifier_id(modifier.id).present? %>
                          <%= link_to transaction_modifier, method: :delete, :remote => true, :id => "delete-modifier-#{transaction_modifier.id}"  do %>
                            <i class="material-icons">delete</i>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
                <% @parent_modifiers.each do |modifier| %>
                  <% if @transaction.transaction_modifiers.find_by_modifier_id(modifier.id).present? %>
                    <% transaction_modifier = @transaction.transaction_modifiers.find_by_modifier_id(modifier.id) %>
                  <% else %>
                    <% transaction_modifier = TransactionModifier.new  %>
                  <% end %>
                  <div id="modifier-<%= modifier.id %>">
                    <%= form_with(model: transaction_modifier, remote: true) do |f| %>
                      <div class="field">
                        <%= f.hidden_field :transaction_id, :value => params[:id] %>
                        <%= f.hidden_field :modifier_id, :value => modifier.id %>
                        <%= f.label "#{modifier.name}" %>
                        <div class="form-group btn-group btn-group-toggle flex-wrap" data-toggle="buttons">
                          <%= f.collection_radio_buttons(:modifier_option_id, modifier.modifier_options, :id, :name, :selected => transaction_modifier.modifier_option_id, class: "radio-auto-submit") do |b| %>
                            <%= b.label(class: "btn btn-sm btn-outline-info") { b.radio_button(class: "radio-auto-submit") + b.text.humanize } %>
                          <% end %>
                        </div>
                        <% if @transaction.transaction_modifiers.find_by_modifier_id(modifier.id).present? %>
                          <%= link_to transaction_modifier, method: :delete, :remote => true, :id => "delete-modifier-#{transaction_modifier.id}"  do %>
                            <i class="material-icons">delete</i>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
        <div class="card-footer">
          <div class="ml-auto">
            <%= link_to 'Signaler un problÃ¨me', "", class: 'btn btn-danger btn-link', "data-toggle" => "modal", "data-target" => "#commentModal" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="commentModalLabel">Signaler un problÃ¨me sur une dÃ©pense</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <%= form_for @comment do |form| %>
              <div class="field">
                <%= form.hidden_field :transaction_id, :value => @transaction.id %>
                <%= form.hidden_field :author, :value => @transaction.user.id %>
              </div>
              <div class="field">
                <%= form.text_area :description, placeholder: "Expliquer en quelques mots le problÃ¨me avec cette dÃ©pense.", class: 'form-control', :autofocus => true, :style => "color:white;" %>
              </div>
              <div class="actions">
                <%= form.submit 'Envoyer mon commentaire', class: 'btn btn-primary' %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    $("input:checked").parent().addClass("selected");

      // hide spinner
      $(".spinner").hide();
      // show spinner on AJAX start
      $(document).ajaxStart(function(){
        $(".spinner").show();
      });
      // hide spinner on AJAX stop
      $(document).ajaxStop(function(){
        $(".spinner").hide();
      });
  });
  $('input[type=radio]').on('change', function() {
   if( $(this).is(':checked') ) {
      form = this.form;
      Rails.fire(form, 'submit');
    }
  });
</script>
